# GitLab CI/CD Pipeline for W-M-E (Wave Agent X)
# Web build + desktop packaging parity with Astral-style workflow

variables:
  PNPM_VERSION: '10.28.2'
  NODE_VERSION: '20'

stages:
  - install
  - build

.pnpm_cache: &pnpm_cache
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store

install:
  stage: install
  image: node:${NODE_VERSION}
  tags:
    - linux-docker
  <<: *pnpm_cache
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm -v
    - pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - apps/*/node_modules/
      - .pnpm-store/
    expire_in: 1 hour

build:web:
  stage: build
  image: node:${NODE_VERSION}
  tags:
    - linux-docker
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
  script:
    - pnpm build:web
  artifacts:
    paths:
      - apps/web/dist/
    expire_in: 1 week

build:desktop:windows:
  stage: build
  image: electronuserland/builder:wine
  tags:
    - linux-docker
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    - export APP_VERSION_MAJOR=1
    - export APP_VERSION_MINOR=0
    - export APP_VERSION_HOTFIX=0
  script:
    - cd apps/desktop
    - pnpm make --win
  artifacts:
    paths:
      - apps/desktop/release/
    expire_in: 1 week
  only:
    - main
    - tags

build:desktop:macos:
  stage: build
  tags:
    - macos
    - shell
  needs: [install]
  before_script:
    - export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile
    - export APP_VERSION_MAJOR=1
    - export APP_VERSION_MINOR=0
    - export APP_VERSION_HOTFIX=0
  script:
    - cd apps/desktop
    - pnpm make --mac
  artifacts:
    paths:
      - apps/desktop/release/
    expire_in: 1 week
  only:
    - main
    - tags
