# W-M-E Build and Deploy

## Overview

W-M-E uses a pnpm workspace with two app targets:

- Web: `apps/web` (Vite)
- Desktop: `apps/desktop` (Electron + electron-vite + electron-builder)

Desktop packaging targets:

- Windows: NSIS `.exe` (x64)
- macOS: `.dmg` (x64 + arm64)
- Linux: `.AppImage`

## Local Build Commands

From repo root:

```bash
bash scripts/pnpmw.sh install
bash scripts/pnpmw.sh dev:web
bash scripts/dev-desktop.sh
bash scripts/pnpmw.sh build:web
bash scripts/pnpmw.sh build:desktop
bash scripts/pnpmw.sh make:win
bash scripts/pnpmw.sh make:mac
bash scripts/pnpmw.sh make:linux
```

## Recommended Onboarding

```bash
bash scripts/bootstrap.sh
```

This script performs install, doctor checks, and smoke builds.

For a one-command desktop startup (including first-run setup/repair):

```bash
bash scripts/run-desktop.sh
```

## Desktop Versioning

Desktop build version metadata is generated by:

- `apps/desktop/scripts/generate-version.mjs`

Inputs:

- `APP_VERSION_MAJOR`
- `APP_VERSION_MINOR`
- `APP_VERSION_HOTFIX`
- `CI_PIPELINE_ID` (for build number suffix)

Output file:

- `apps/desktop/src/version.ts`

## CI Pipeline (`.gitlab-ci.yml`)

Stages:

1. `install`
2. `build`

Jobs:

- `install`: shared pnpm install + cache/artifacts
- `build:web`: `pnpm build:web`
- `build:desktop:windows`: `pnpm make --win`
- `build:desktop:macos`: `pnpm make --mac` (mac runner required)

## Artifact Locations

- Web: `apps/web/dist/`
- Desktop: `apps/desktop/release/<version>/`

## Windows Packaging Notes

Windows EXE output is generated through Electron Builder NSIS target.
The output installer appears in `apps/desktop/release/<version>/`.

## macOS Packaging Notes

Building `.dmg` requires a macOS machine/runner.
On Windows/WSL, the build path can be configured but not fully executed natively.

## Troubleshooting

### Tooling mismatch

Run:

```bash
bash scripts/doctor.sh
```

### pnpm install issues

```bash
bash scripts/bootstrap.sh
```

### Desktop packaging failures

1. Re-run `bash scripts/pnpmw.sh build:desktop`
2. Re-run platform package command with `bash scripts/pnpmw.sh make:<platform>`
3. Inspect `apps/desktop/release/` and build logs

### Desktop preview/dev fails with `ipcMain` undefined

This usually means `ELECTRON_RUN_AS_NODE=1` is set in your shell.
Use `bash scripts/doctor.sh` to confirm. Desktop run scripts clear this variable automatically.
